{% extends 'base.html' %}
{% block content %}
<div class="nx-card bg-white p-5">
  <div class="flex items-center justify-between flex-wrap gap-2">
    <h2 class="text-xl font-extrabold">QR 스캔 — {{ booth.name }}</h2>
    <div class="text-sm text-slate-600">Booth ID: {{ booth.id }}</div>
  </div>

  <!-- 컨트롤 -->
  <div class="mt-4 grid md:grid-cols-3 gap-4">
    <!-- 카메라 프리뷰 -->
    <div class="md:col-span-2">
      <div class="relative w-full max-w-xl">
        <video id="preview" autoplay playsinline muted
               class="w-full rounded-xl bg-black aspect-video object-cover"></video>
        <canvas id="overlay" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>

        <div class="absolute top-2 right-2 flex gap-2">
          <button id="startBtn" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm">스캔 시작</button>
          <button id="stopBtn" class="px-3 py-1.5 rounded-lg bg-slate-700 text-white text-sm">일시 정지</button>
          <button id="swapBtn" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm">카메라 전환</button>
        </div>
      </div>

      <p class="text-xs text-slate-500 mt-2">
        카메라가 열리지 않으면 HTTPS가 필요한지, 브라우저 권한(카메라 허용)을 확인하세요.
      </p>
    </div>

    <!-- 포인트/사유/수동 입력 -->
    <div class="">
      <div class="space-y-4">
        <div>
          <label class="block text-sm mb-1 font-semibold">포인트 증감(Δ)</label>
          <div class="flex items-center gap-2">
            <input id="delta" type="number" value="0" class="w-28 border rounded-lg p-2">
            <div class="flex flex-wrap gap-1">
              <button class="px-2 py-1 rounded bg-slate-100" data-d="+1">+1</button>
              <button class="px-2 py-1 rounded bg-slate-100" data-d="+5">+5</button>
              <button class="px-2 py-1 rounded bg-slate-100" data-d="+10">+10</button>
              <button class="px-2 py-1 rounded bg-slate-100" data-d="-1">-1</button>
              <button class="px-2 py-1 rounded bg-slate-100" data-d="-5">-5</button>
              <button class="px-2 py-1 rounded bg-slate-100" data-d="-10">-10</button>
              <button class="px-2 py-1 rounded bg-amber-100" id="resetDelta">0</button>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm mb-1 font-semibold">사유(선택)</label>
          <input id="reason" class="w-full border rounded-lg p-2" placeholder="예) 게임 참여 보상">
        </div>

        <div class="border-t pt-4">
          <label class="block text-sm mb-1 font-semibold">수동 입력(폴백)</label>
          <input id="manualToken" class="w-full border rounded-lg p-2" placeholder="QR 텍스트/토큰 붙여넣기">
          <button id="manualSubmit" class="mt-2 w-full bg-slate-900 text-white rounded-lg py-2">수동 적용</button>
          <p class="text-xs text-slate-500 mt-1">QR 스캔이 어려울 때 사용</p>
        </div>

        <div class="border-t pt-4">
          <div class="text-sm font-semibold mb-1">최근 처리 결과</div>
          <div id="result" class="text-sm bg-slate-50 rounded-lg p-3 text-slate-700">
            아직 없음
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jsQR (QR 디코더) -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
  const videoEl = document.getElementById('preview');
  const overlay = document.getElementById('overlay');
  const ctxOv = overlay.getContext('2d');

  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const swapBtn  = document.getElementById('swapBtn');

  const deltaInput = document.getElementById('delta');
  const reasonInput = document.getElementById('reason');
  const resultBox = document.getElementById('result');
  const manualToken = document.getElementById('manualToken');
  const manualSubmit = document.getElementById('manualSubmit');

  // 빠른 증감 버튼
  document.querySelectorAll('[data-d]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const v = parseInt(deltaInput.value || '0', 10);
      const d = parseInt(btn.getAttribute('data-d'), 10);
      deltaInput.value = v + d;
    });
  });
  document.getElementById('resetDelta').addEventListener('click', ()=> deltaInput.value = 0);

  let currentStream = null;
  let currentDeviceId = null;
  let videoInputs = [];
  let scanning = false;
  let rafId = null;
  let lastScan = { token: null, ts: 0 };

  // 짧은 비프(성공 피드백)
  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type = 'sine';
      o.frequency.value = 880;
      g.gain.setValueAtTime(0.15, ctx.currentTime);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
    }catch(_){}
  }

  // 카메라 시작
  async function startCamera(videoConstraints) {
    try {
      if (currentStream) { currentStream.getTracks().forEach(t => t.stop()); }
      const stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: false });
      currentStream = stream;
      videoEl.srcObject = stream;

      const track = stream.getVideoTracks()[0];
      const settings = track.getSettings();
      currentDeviceId = settings.deviceId || null;
      videoEl.setAttribute('playsinline','');

      // 디바이스 목록 갱신
      const devices = await navigator.mediaDevices.enumerateDevices();
      videoInputs = devices.filter(d => d.kind === 'videoinput');

      // 비디오 메타데이터 로드 후 오버레이 크기 맞춤
      await new Promise(res=>{
        if (videoEl.readyState >= 2) return res();
        videoEl.onloadedmetadata = res;
      });
      resizeOverlay();
    } catch (err) {
      alert('카메라를 열 수 없습니다: ' + (err?.message || err));
    }
  }

  function resizeOverlay(){
    const r = videoEl.getBoundingClientRect();
    overlay.width  = r.width * devicePixelRatio;
    overlay.height = r.height * devicePixelRatio;
  }
  window.addEventListener('resize', ()=>{ if(videoEl.srcObject) resizeOverlay(); });

  async function startScanLoop(){
    if (scanning) return;
    scanning = true;
    loop();
  }
  function stopScanLoop(){
    scanning = false;
    if (rafId) cancelAnimationFrame(rafId);
    ctxOv.clearRect(0,0,overlay.width, overlay.height);
  }

  function loop(){
    if (!scanning) return;
    try {
      const w = overlay.width, h = overlay.height;
      ctxOv.clearRect(0,0,w,h);

      // 비디오 프레임을 오프스크린 캔버스에 그려서 디코딩
      const canvas = document.createElement('canvas');
      const scale = 1.0;
      canvas.width = Math.floor(w/scale);
      canvas.height = Math.floor(h/scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);

      const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'attemptBoth' });

      if (code && code.data) {
        drawBox(ctxOv, code.location, '#22c55e');
        onQrDetected(code.data);
      } else {
        drawGuide(ctxOv);
      }
    } catch (e) {
      // ignore frame errors
    }
    rafId = requestAnimationFrame(loop);
  }

  function drawGuide(ctx){
    const w = overlay.width, h = overlay.height;
    const size = Math.min(w,h)*0.6;
    const x = (w - size)/2, y = (h - size)/2;
    ctx.strokeStyle = 'rgba(255,255,255,.8)';
    ctx.lineWidth = 4;
    ctx.strokeRect(x,y,size,size);
  }

  function drawBox(ctx, loc, color){
    ctx.lineWidth = 4;
    ctx.strokeStyle = color || '#22c55e';
    if (!loc) return;
    ctx.beginPath();
    ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
    ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
    ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
    ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
    ctx.closePath();
    ctx.stroke();
  }

  function normalizeToken(raw){
    // "TAG|student_id|token" 형태도 허용 → 마지막 파트를 token으로 사용
    if (typeof raw !== 'string') return '';
    const s = raw.trim();
    if (s.includes('|')) return s.split('|').pop().trim();
    return s;
  }

  async function onQrDetected(raw){
    const now = Date.now();
    const token = normalizeToken(raw);
    if (!token) return;

    // 중복/연타 방지: 같은 토큰 1.5초 이내 재처리 금지
    if (lastScan.token === token && (now - lastScan.ts) < 1500) return;
    lastScan = { token, ts: now };

    const delta = parseInt(deltaInput.value || '0', 10) || 0;
    const reason = (reasonInput.value || '').trim();

    try{
      const { data } = await axios.post('/api/transaction', {
        qr: token,
        delta,
        reason,
        booth_id: {{ booth.id }}
      });
      beep();
      const u = data?.user;
      resultBox.textContent = `적용 성공: ${u?.name || '학생'} (${u?.student_id || '-'}) 현재포인트 ${u?.points}`;
      // 필요시 delta 초기화 원하면 아래 주석 해제
      // deltaInput.value = 0;
    }catch(e){
      const msg = e?.response?.data?.error || e?.message || '적용 실패';
      resultBox.textContent = '오류: ' + msg;
    }
  }

  // 버튼 바인딩
  startBtn.addEventListener('click', ()=> startScanLoop());
  stopBtn.addEventListener('click', ()=> stopScanLoop());
  manualSubmit.addEventListener('click', ()=>{
    const t = manualToken.value.trim();
    if (!t) return alert('토큰을 입력하세요.');
    onQrDetected(t);
  });

  // 카메라 전환
  swapBtn.addEventListener('click', async ()=>{
    try{
      if (videoInputs.length <= 1) {
        // 카메라 1개면 facingMode 토글
        const curFacing = currentStream?.getVideoTracks()[0]?.getSettings()?.facingMode;
        const nextFacing = (curFacing === 'environment') ? 'user' : 'environment';
        await startCamera({ facingMode: { ideal: nextFacing } });
      } else {
        // 다음 디바이스로
        const idx = videoInputs.findIndex(d => d.deviceId === currentDeviceId);
        const next = videoInputs[(idx + 1) % videoInputs.length];
        await startCamera({ deviceId: { exact: next.deviceId } });
      }
      // 전환 후 스캔이 멈춰 있으면 다시 시작
      if (!scanning) startScanLoop();
    }catch(e){
      alert('전환 실패: ' + (e?.message || e));
    }
  });

  // 페이지 로드 시 후면 우선으로 시도 + 자동 스캔 시작
  (async ()=>{
    await startCamera({ facingMode: { ideal: 'environment' } });
    startScanLoop();
  })();
</script>
{% endblock %}
