{% extends 'base.html' %}
{% block content %}
<h2 class="text-xl font-extrabold mb-4">관리자 대시보드</h2>

<!-- 공지 보내기 -->
<div class="nx-card bg-white p-5 mb-6">
  <div class="flex items-center justify-between">
    <h3 class="text-lg font-semibold">학생 알림 보내기</h3>
  </div>

  {% if is_superadmin %}
  <!-- 최고 관리자 -->
  <div class="grid md:grid-cols-3 gap-3 mt-3">
    <input id="notify-message" class="border rounded-lg p-2 md:col-span-2" placeholder="메시지 입력">
    <select id="notify-target" class="border rounded-lg p-2">
      <option value="all">전체 학생</option>
      <option value="student">특정 학번</option>
      <option value="booth">부스 페이지 시청자</option>
    </select>
    <input id="notify-student-id" class="border rounded-lg p-2 hidden" placeholder="학번 (특정 학번)">
    <select id="notify-booth-id" class="border rounded-lg p-2 hidden">
      <option value="">부스 선택</option>
      {% for b in booths %}
        <option value="{{ b.id }}">{{ b.name }} (id={{ b.id }})</option>
      {% endfor %}
    </select>
  </div>
  <button onclick="sendNotifySuper()" class="mt-3 px-3 py-2 rounded-lg bg-indigo-600 text-white">보내기</button>
  {% else %}
  <!-- 부스 관리자 -->
  <div class="grid md:grid-cols-3 gap-3 mt-3">
    <input id="notify-message" class="border rounded-lg p-2 md:col-span-2" placeholder="메시지 입력">
    <select id="notify-booth-id" class="border rounded-lg p-2">
      <option value="">내 부스 선택</option>
      {% for b in booths %}
        <option value="{{ b.id }}">{{ b.name }} (id={{ b.id }})</option>
      {% endfor %}
    </select>
  </div>
  <button onclick="sendNotifyBoothOnly()" class="mt-3 px-3 py-2 rounded-lg bg-indigo-600 text-white">보내기</button>
  {% endif %}
</div>

{% if is_superadmin %}
<!-- 지도 관리 -->
<div class="nx-card bg-white p-5 mb-6">
  <div class="flex items-center justify-between">
    <h3 class="text-lg font-semibold">학교 지도 관리</h3>
    <span class="text-sm text-gray-500">최대 {{ map_limit }}장</span>
  </div>

  <form class="mt-4" method="post" action="{{ url_for('admin_maps_upload') }}" enctype="multipart/form-data">
    <input type="file" name="images" accept="image/*" multiple class="block text-sm">
    <button class="mt-3 px-3 py-2 rounded-lg bg-indigo-600 text-white">업로드</button>
  </form>

  <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-3">
    {% for m in maps %}
      <div class="relative">
        <img class="w-full h-28 object-cover rounded-lg"
             src="{{ url_for('uploaded_file', filename=m.filename) }}"
             alt="지도 {{ loop.index }}">
        <form method="post"
              action="{{ url_for('admin_maps_delete', image_id=m.id) }}"
              onsubmit="return confirm('삭제할까요?')"
              class="absolute top-1 right-1">
          <button class="bg-red-600 text-white text-xs px-2 py-1 rounded">삭제</button>
        </form>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- 부스 관리 카드들 -->
<div class="grid md:grid-cols-2 gap-6">
  {% for b in booths %}
  <div class="nx-card bg-white p-5">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">{{ b.name }}</h3>
      <a href="{{ url_for('admin_scan', booth_id=b.id) }}" class="text-sm text-indigo-600 hover:underline">QR 스캔</a>
    </div>

    <div class="text-sm text-gray-600 mt-1">현재 대기 인원: <span id="q-{{ b.id }}">{{ b.queue_length }}</span>명</div>

    <!-- 대기자 추가 -->
    <div class="mt-4">
      <label class="text-sm block mb-1 font-semibold">대기자 추가</label>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input id="wl-sid-{{ b.id }}" class="border rounded-lg p-2" placeholder="학번(선택)">
        <input id="wl-name-{{ b.id }}" class="border rounded-lg p-2 md:col-span-2" placeholder="이름(필수)">
      </div>
      <button onclick="addWait({{ b.id }})" class="mt-2 px-3 py-2 rounded-lg bg-slate-900 text-white">추가</button>
    </div>

    <!-- 대기명단 -->
    <div class="mt-4 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left text-gray-500">
            <th class="py-2 pr-2">#</th>
            <th class="py-2 pr-2">학번</th>
            <th class="py-2 pr-2">이름</th>
            <th class="py-2 pr-2">등록시간</th>
            <th class="py-2 pr-2">작업</th>
          </tr>
        </thead>
        <tbody id="wl-list-{{ b.id }}">
          <!-- 초기 로드는 JS에서 -->
        </tbody>
      </table>
    </div>
  </div>
  {% endfor %}
</div>

<script>
  const socket = io();
  socket.emit('join', {room: 'booths'});

  // 초기 로드 + 실시간 반영
  {% for b in booths %}
  axios.get(`/api/waitlist/{{ b.id }}`).then(res => {
    renderWaitlist({{ b.id }}, res.data.entries);
    const qEl = document.getElementById('q-{{ b.id }}');
    if (qEl) qEl.textContent = res.data.count;
  });
  socket.emit('join', {room: 'booth_{{ b.id }}'});
  {% endfor %}

  socket.on('queue_update', (data) => {
    const el = document.getElementById('q-' + data.booth_id);
    if (el) el.textContent = data.queue_length;
  });

  socket.on('waitlist_update', (data) => {
    renderWaitlist(data.booth_id, data.entries);
    const el = document.getElementById('q-' + data.booth_id);
    if (el) el.textContent = data.count;
  });

  function renderWaitlist(boothId, entries) {
    const tbody = document.getElementById('wl-list-' + boothId);
    if (!tbody) return;
    tbody.innerHTML = '';
    entries.forEach((e, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="py-2 pr-2">${idx+1}</td>
        <td class="py-2 pr-2">${e.student_id || ''}</td>
        <td class="py-2 pr-2">${e.name}</td>
        <td class="py-2 pr-2">${(e.created_at || '').replace('T',' ')}</td>
        <td class="py-2 pr-2">
          <button class="text-red-600" onclick="removeWait(${boothId}, ${e.id})">삭제</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  async function addWait(boothId) {
    const sid = document.getElementById('wl-sid-' + boothId).value.trim();
    const name = document.getElementById('wl-name-' + boothId).value.trim();
    if (!name) { alert('이름을 입력하세요.'); return; }
    try {
      await axios.post(`/api/waitlist/${boothId}/add`, {student_id: sid, name});
      document.getElementById('wl-name-' + boothId).value = '';
    } catch (e) {
      alert(e?.response?.data?.error || '추가 실패');
    }
  }

  async function removeWait(boothId, entryId) {
    if (!confirm('삭제할까요?')) return;
    try {
      await axios.post(`/api/waitlist/${boothId}/remove`, {entry_id: entryId});
    } catch (e) {
      alert(e?.response?.data?.error || '삭제 실패');
    }
  }

  {% if is_superadmin %}
  const targetSel = document.getElementById('notify-target');
  const studentInput = document.getElementById('notify-student-id');
  const boothSel = document.getElementById('notify-booth-id');
  function toggleNotifyFields(){
    const t = targetSel.value;
    studentInput.classList.toggle('hidden', t !== 'student');
    boothSel.classList.toggle('hidden', t !== 'booth');
  }
  targetSel.addEventListener('change', toggleNotifyFields);
  toggleNotifyFields();

  async function sendNotifySuper() {
    const message = document.getElementById('notify-message').value.trim();
    const target = targetSel.value;
    const student_id = studentInput.value.trim();
    const booth_id = boothSel.value;
    try {
      await axios.post('/api/notify', { message, target, student_id, booth_id });
      alert('발송 완료');
    } catch (e) {
      alert(e?.response?.data?.error || '발송 실패');
    }
  }
  {% else %}
  const boothSel = document.getElementById('notify-booth-id');
  async function sendNotifyBoothOnly() {
    const message = document.getElementById('notify-message').value.trim();
    const booth_id = boothSel.value;
    try {
      await axios.post('/api/notify', { message, target: 'booth', booth_id });
      alert('발송 완료');
    } catch (e) {
      alert(e?.response?.data?.error || '발송 실패');
    }
  }
  {% endif %}
</script>
{% endblock %}
